/**
 * CATEGORY VULNERABILITY MAP
 * 
 * Per-user weighting (1-3) for each behavior category.
 * Determines which categories the AI emphasizes in coaching.
 * 
 * Philosophy:
 * - Not all behaviors matter equally for every user
 * - Sleep variance might be catastrophic for one user, resilient for another
 * - This is a DIAL, not a static flag - can be adjusted manually
 * - Never auto-adjusts weekly (stability is critical)
 * 
 * Weights:
 * - 3 = High vulnerability (variance cascades into everything)
 * - 2 = Moderate vulnerability (important but not catastrophic)
 * - 1 = Low vulnerability (resilient, localized impact)
 * 
 * Storage: users/{email}/coachingProfile/vulnerabilityMap
 */

import { doc, getDoc, setDoc } from "firebase/firestore";
import { db } from "@/app/firebase/config";

// ============================================================================
// TYPES
// ============================================================================

export interface CategoryVulnerability {
  baseline: 1 | 2 | 3;           // Default weight set at onboarding or first coaching
  current: 1 | 2 | 3;            // Active weight (can be manually adjusted)
  lastAdjusted?: string;         // ISO date of last manual change
  adjustmentReason?: string;     // Why it was changed (e.g., "Travel season", "New baby")
}

export interface VulnerabilityMap {
  sleep: CategoryVulnerability;
  protein: CategoryVulnerability;
  hydration: CategoryVulnerability;
  nutrition_quality: CategoryVulnerability;
  portion_control: CategoryVulnerability;
  exercise: CategoryVulnerability;
  bonus_movement: CategoryVulnerability;
  primaryGoal?: string; // User's selected goal from onboarding
  
  createdAt: string;
  updatedAt: string;
}

// ============================================================================
// DEFAULT VULNERABILITY PROFILES
// ============================================================================

/**
 * Default vulnerability map (used if none exists)
 * 
 * Based on common patterns observed:
 * - Sleep is typically high vulnerability (affects everything)
 * - Protein/Nutrition are moderate (important for goals)
 * - Hydration/Bonus Movement are low (resilient)
 */
function getDefaultVulnerabilityMap(): VulnerabilityMap {
  const now = new Date().toISOString();
  
  const createDefault = (baseline: 1 | 2 | 3): CategoryVulnerability => ({
    baseline,
    current: baseline
  });
  
  return {
    sleep: createDefault(3),              // Moderate - cascades into everything
    nutrition_quality: createDefault(3),  // High - #1 momentum killer
    portion_control: createDefault(2),     // Moderate - affects performance
    exercise: createDefault(2),           // Moderate - central to momentum
    protein: createDefault(2),            // Moderate - important for recovery/goals
    hydration: createDefault(1),          // Low - resilient unless extreme
    bonus_movement: createDefault(1),     // Low - supplemental only
    createdAt: now,
    updatedAt: now
  };
}

/**
 * Generate personalized default based on user constraints
 * 
 * Future enhancement: adjust defaults based on:
 * - Age (older → sleep more vulnerable)
 * - Recovery capacity (low → exercise more vulnerable)
 * - Body composition phase (fat-loss → nutrition more vulnerable)
 */
function getPersonalizedDefaults(constraints?: {
  recoveryCapacity: "low" | "moderate" | "high";
  bodyCompositionPhase: string;
}): VulnerabilityMap {
  const defaults = getDefaultVulnerabilityMap();
  
  // If no constraints provided, return generic defaults
  if (!constraints) return defaults;
  
  // Adjust based on recovery capacity
  if (constraints.recoveryCapacity === "low") {
    // Low recovery = sleep and exercise more critical
    defaults.sleep.baseline = 3;
    defaults.sleep.current = 3;
    defaults.exercise.baseline = 3;
    defaults.exercise.current = 3;
  }
  
  // Adjust based on body composition phase
  if (constraints.bodyCompositionPhase === "fat-loss") {
    // Fat loss = nutrition and protein more critical
    defaults.nutrition_quality.baseline = 3;
    defaults.nutrition_quality.current = 3;
    defaults.protein.baseline = 3;
    defaults.protein.current = 3;
  }
  
  if (constraints.bodyCompositionPhase === "muscle-gain") {
    // Muscle gain = protein and exercise more critical
    defaults.protein.baseline = 3;
    defaults.protein.current = 3;
    defaults.exercise.baseline = 3;
    defaults.exercise.current = 3;
  }
  
  return defaults;
}

// ============================================================================
// FIRESTORE OPERATIONS
// ============================================================================

/**
 * Get vulnerability map for a user
 * Creates default if none exists
 */
export async function getVulnerabilityMap(email: string): Promise<VulnerabilityMap> {
  const mapRef = doc(db, "users", email, "coachingProfile", "vulnerabilityMap");
  const mapSnap = await getDoc(mapRef);
  
  if (mapSnap.exists()) {
    return mapSnap.data() as VulnerabilityMap;
  }
  
  // No map exists - create default
  const defaultMap = getDefaultVulnerabilityMap();
  await setDoc(mapRef, defaultMap);
  
  return defaultMap;
}

/**
 * Get vulnerability map with personalized defaults
 * (Call this during first coaching generation to set smart defaults)
 */
export async function getOrCreateVulnerabilityMap(
  email: string,
  constraints?: {
    recoveryCapacity: "low" | "moderate" | "high";
    bodyCompositionPhase: string;
  }
): Promise<VulnerabilityMap> {
  const mapRef = doc(db, "users", email, "coachingProfile", "vulnerabilityMap");
  const mapSnap = await getDoc(mapRef);
  
  if (mapSnap.exists()) {
    return mapSnap.data() as VulnerabilityMap;
  }
  
  // Fetch user's primary goal from top-level user doc
  const userDocRef = doc(db, "users", email);
  const userDoc = await getDoc(userDocRef);
  const primaryGoal = userDoc.exists() ? (userDoc.data().primaryFocus || 'not_specified') : 'not_specified';
  
  // Create personalized defaults
  const personalizedMap = getPersonalizedDefaults(constraints);
  personalizedMap.primaryGoal = primaryGoal;
  
  await setDoc(mapRef, personalizedMap);
  
  return personalizedMap;
}

/**
 * Manually adjust a category's vulnerability
 * (Admin function - not exposed to users initially)
 */
/**
 * Manually adjust a category's vulnerability
 * (Admin function - not exposed to users initially)
 */
export async function adjustVulnerability(
  email: string,
  category: "sleep" | "protein" | "hydration" | "nutrition_quality" | "portion_control" | "exercise" | "bonus_movement",
  newWeight: 1 | 2 | 3,
  reason: string
): Promise<void> {
  const mapRef = doc(db, "users", email, "coachingProfile", "vulnerabilityMap");
  const mapSnap = await getDoc(mapRef);
  
  if (!mapSnap.exists()) {
    throw new Error(`Vulnerability map not found for ${email}`);
  }
  
  const map = mapSnap.data() as VulnerabilityMap;
  
  // Update the specific category
  const categoryData = map[category];
  map[category] = {
    baseline: categoryData.baseline,
    current: newWeight,
    lastAdjusted: new Date().toISOString(),
    adjustmentReason: reason
  };
  
  map.updatedAt = new Date().toISOString();
  
  await setDoc(mapRef, map);
}

/**
 * Reset a category to its baseline
 * (Use when temporary adjustment period ends)
 */
export async function resetToBaseline(
  email: string,
  category: "sleep" | "protein" | "hydration" | "nutrition_quality" | "portion_control" | "exercise" | "bonus_movement"
): Promise<void> {
  const mapRef = doc(db, "users", email, "coachingProfile", "vulnerabilityMap");
  const mapSnap = await getDoc(mapRef);
  
  if (!mapSnap.exists()) {
    throw new Error(`Vulnerability map not found for ${email}`);
  }
  
  const map = mapSnap.data() as VulnerabilityMap;
  
  // Reset to baseline
  const categoryData = map[category];
  map[category] = {
    baseline: categoryData.baseline,
    current: categoryData.baseline,
    lastAdjusted: new Date().toISOString(),
    adjustmentReason: "Reset to baseline"
  };
  
  map.updatedAt = new Date().toISOString();
  
  await setDoc(mapRef, map);
}

// ============================================================================
// COACHING INTEGRATION
// ============================================================================

/**
 * Format vulnerability map for AI prompt
 * 
 * Returns human-readable description of which categories matter most
 */
export function formatVulnerabilityForPrompt(map: VulnerabilityMap): string {
   // Map primaryGoal codes to human-readable descriptions
   const goalDescriptions: Record<string, string> = {
    'consistency': 'Build consistency',
    'stronger_leaner': 'Feel stronger and leaner',
    'energy': 'Have more daily energy',
    'control': 'Get back in control',
    'long_term_health': 'Improve long-term health',
    'not_specified': 'Not specified'
  };
  
  const goalText = goalDescriptions[map.primaryGoal || 'not_specified'] || 'Not specified';
  
  const categories = [
    { name: "Sleep", key: "sleep", weight: map.sleep.current },
    { name: "Protein", key: "protein", weight: map.protein.current },
    { name: "Hydration", key: "hydration", weight: map.hydration.current },
    { name: "Nutrition Pattern", key: "nutrition_quality", weight: map.nutrition_quality.current },
    { name: "Energy Balance", key: "portion_control", weight: map.portion_control.current },
    { name: "Exercise", key: "exercise", weight: map.exercise.current },
    { name: "Bonus Movement", key: "bonus_movement", weight: map.bonus_movement.current }
  ];
  
  const high = categories.filter(c => c.weight === 3).map(c => c.name);
  const moderate = categories.filter(c => c.weight === 2).map(c => c.name);
  const low = categories.filter(c => c.weight === 1).map(c => c.name);
  
  const lines: string[] = [];
  
  lines.push(`PRIMARY GOAL: ${goalText}`);
  lines.push('');
  
  if (high.length > 0) {
    lines.push(`High vulnerability (variance cascades): ${high.join(", ")}`);
  }
  
  if (moderate.length > 0) {
    lines.push(`Moderate vulnerability: ${moderate.join(", ")}`);
  }
  
  if (low.length > 0) {
    lines.push(`Low vulnerability (resilient): ${low.join(", ")}`);
  }
  
  return lines.join("\n");
}
/**
 * Get the most vulnerable categories for emphasis in coaching
 */
export function getHighVulnerabilityCategories(map: VulnerabilityMap): string[] {
  const categories = [
    { name: "sleep", weight: map.sleep.current },
    { name: "protein", weight: map.protein.current },
    { name: "hydration", weight: map.hydration.current },
    { name: "nutrition_quality", weight: map.nutrition_quality.current },
    { name: "portion_control", weight: map.portion_control.current },
    { name: "exercise", weight: map.exercise.current },
    { name: "bonus_movement", weight: map.bonus_movement.current }
  ];
  
  return categories
    .filter(c => c.weight === 3)
    .map(c => c.name);
}

// ============================================================================
// EXAMPLE USAGE
// ============================================================================

/**
 * Example: DJ's vulnerability map (based on his feedback)
 * 
 * High vulnerability:
 * - Sleep (cascades into everything when off)
 * - Nutrition Pattern (weekend disruption is primary pattern)
 * 
 * Moderate:
 * - Protein, Exercise (important but not catastrophic)
 * 
 * Low:
 * - Hydration, Bonus Movement (resilient)
 * 
 * AI coaching would emphasize:
 * - "Sleep dropped to 4/7 nights - for you, this is critical"
 * - "Weekend nutrition disruption is your dominant pattern"
 * - NOT: "Hydration was only 5/7 days" (low vulnerability, ignore)
 */